---
import BaseLayout from '../../layouts/BaseLayout.astro';
export const prerender = false;
---

<BaseLayout title="Authenticating..." description="Completing authentication">
  <div class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="w-16 h-16 mx-auto mb-4">
        <svg class="w-full h-full animate-spin text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
      </div>
      <h2 class="text-xl font-semibold text-white mb-2">Completing sign in...</h2>
      <p class="text-gray-400">Please wait while we authenticate you.</p>
    </div>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';

    async function handleCallback() {
      if (!supabase) {
        window.location.href = '/auth/login?error=configuration';
        return;
      }

      // Get the hash from the URL (Supabase returns tokens in the hash)
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const refreshToken = hashParams.get('refresh_token');

      // Also check query params for code flow
      const queryParams = new URLSearchParams(window.location.search);
      const code = queryParams.get('code');
      const error = queryParams.get('error');
      const errorDescription = queryParams.get('error_description');

      if (error) {
        console.error('Auth error:', error, errorDescription);
        window.location.href = `/auth/login?error=${encodeURIComponent(errorDescription || error)}`;
        return;
      }

      try {
        if (code) {
          // Exchange code for session
          const { error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);
          if (exchangeError) {
            console.error('Code exchange error:', exchangeError);
            window.location.href = `/auth/login?error=${encodeURIComponent(exchangeError.message)}`;
            return;
          }
        } else if (accessToken && refreshToken) {
          // Set session from tokens
          const { error: sessionError } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken,
          });
          if (sessionError) {
            console.error('Session error:', sessionError);
            window.location.href = `/auth/login?error=${encodeURIComponent(sessionError.message)}`;
            return;
          }
        }

        // Verify we have a session
        const { data: { session } } = await supabase.auth.getSession();

        if (session) {
          // Success - redirect to dashboard
          window.location.href = '/dashboard';
        } else {
          // No session found
          window.location.href = '/auth/login?error=no_session';
        }
      } catch (err) {
        console.error('Callback error:', err);
        window.location.href = '/auth/login?error=unknown';
      }
    }

    // Run on page load
    handleCallback();
  </script>
</BaseLayout>
