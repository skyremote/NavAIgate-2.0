---
phase: 11-email-builder-v2
plan: 01
type: execute
---

<objective>
Rebuild the Email Builder into a professional HTML email builder with AI generation and drag-and-drop modules.

Purpose: Enable users to create beautiful, Outlook-compatible HTML emails either through AI assistance or manual drag-and-drop module composition.
Output: Working email builder with AI integration, module library, visual canvas, and HTML export.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/components/EmailBuilder.tsx
@src/pages/tools/email-builder.astro

**Reference HTML Files (design patterns):**
- /Users/Sky/Downloads/bluplai-survey.html - Survey with export functionality
- /Users/Sky/Downloads/montessori-school-info.html - Professional document with sections

**OpenRouter API Key:**
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

**Requirements:**
1. AI-powered email generation using OpenRouter
2. Drag-and-drop module library for manual email building
3. Visual canvas/builder interface
4. HTML output compatible with Outlook (inline CSS)
5. Two modes: AI Generate vs Manual Builder
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server-side API route for AI generation</name>
  <files>src/pages/api/generate-email.ts, .env.example</files>
  <action>
    Create Astro API route to securely call OpenRouter:

    src/pages/api/generate-email.ts:
    - POST endpoint accepting { emailType, tone, recipientName, recipientCompany, context, senderName }
    - Call OpenRouter API with OPENROUTER_API_KEY from env
    - Use claude-3-haiku-20240307 model for cost efficiency
    - System prompt: "You are an email writing assistant. Generate professional emails."
    - Return JSON: { subject, body }

    API endpoint: https://openrouter.ai/api/v1/chat/completions
    Headers:
      - Authorization: Bearer ${import.meta.env.OPENROUTER_API_KEY}
      - HTTP-Referer: https://navaigate.dev
      - X-Title: NavAIgate Email Builder

    Update .env.example to include OPENROUTER_API_KEY placeholder.

    Create .env locally with actual key: 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
  </action>
  <verify>curl -X POST http://localhost:4321/api/generate-email with test payload returns generated email</verify>
  <done>API route securely proxies to OpenRouter, key not exposed to frontend</done>
</task>

<task type="auto">
  <name>Task 2: Create email module component library</name>
  <files>src/components/email-builder/modules/index.ts, src/components/email-builder/modules/*.tsx</files>
  <action>
    Create reusable email module components with Outlook-compatible inline styles:

    Modules to create:
    - HeaderModule: Company logo/name header with gradient background
    - HeroModule: Large title with subtitle and optional background
    - TextModule: Rich text paragraph block
    - CTAModule: Call-to-action button (table-based for Outlook)
    - DividerModule: Horizontal divider line
    - ImageModule: Centered image with optional caption
    - ListModule: Bullet or numbered list
    - QuoteModule: Highlighted quote/callout box
    - FooterModule: Footer with contact info/links
    - SpacerModule: Vertical spacing

    Each module should:
    - Accept props for customization (text, colors, etc.)
    - Render as React for preview
    - Export toHTML() function returning Outlook-compatible HTML with inline CSS

    Use table-based layout for Outlook compatibility. Reference montessori HTML for design patterns.
  </action>
  <verify>All module files exist with both React render and toHTML export</verify>
  <done>10 email modules created with preview and HTML export capabilities</done>
</task>

<task type="auto">
  <name>Task 3: Create drag-and-drop canvas builder</name>
  <files>src/components/email-builder/EmailCanvas.tsx, src/components/email-builder/ModulePalette.tsx, src/components/email-builder/EmailBuilderV2.tsx</files>
  <action>
    Build the visual email builder interface:

    ModulePalette.tsx:
    - Sidebar showing all available modules as draggable items
    - Module icons and names
    - Click to add to canvas

    EmailCanvas.tsx:
    - Drop zone for modules
    - Render stacked modules in order
    - Click module to select and edit
    - Drag to reorder modules
    - Delete button on each module
    - Use @dnd-kit/core for drag-drop (already common, or use native HTML5 DnD)

    EmailBuilderV2.tsx:
    - Main component with two tabs: "AI Generate" and "Build Manually"
    - AI tab: Form with context, tone, recipient â†’ generates email
    - Build tab: ModulePalette + EmailCanvas side by side
    - Preview panel showing rendered email
    - "Export HTML" button to download or open in new tab
    - "Copy HTML" button

    Match existing NavAIgate dark theme (gray-900, glass cards, purple/cyan accents).
  </action>
  <verify>npm run build passes, component renders with both AI and builder modes</verify>
  <done>Visual builder with drag-drop modules, AI generation tab, and preview</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Email Builder V2 with AI generation and drag-drop modules</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:4321/tools/email-builder
    3. Test AI Mode:
       - Fill in recipient, context, tone
       - Click "Generate with AI"
       - Verify email is generated
    4. Test Builder Mode:
       - Click "Build Manually" tab
       - Drag modules from palette to canvas
       - Reorder modules
       - Edit module content
    5. Test Export:
       - Click "Export HTML"
       - Verify HTML opens in new tab
       - Select all, copy, paste into Outlook or email client
       - Confirm formatting is preserved
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] AI generation works with OpenRouter
- [ ] All 10 modules render correctly in preview
- [ ] Drag-and-drop reordering works
- [ ] HTML export produces Outlook-compatible output
- [ ] Copy-paste into Outlook preserves formatting
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Users can generate emails via AI or build manually with modules
- HTML output works in Outlook when copy-pasted
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-email-builder-v2/11-01-SUMMARY.md`
</output>
